version: '3.9'

networks:
  gax-network:
    driver: bridge

services:
  # ==========================================
  # INFRASTRUCTURE (DATABASES & BROKERS)
  # ==========================================

  # --- Kafka ---
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - gax-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    ports:
      - "9292:9292" # Port from your table
      - "9092:9092" # Internal standard
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Настройка слушателей: внутри сети по 9092, снаружи (если надо) по 9292
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9292
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    networks:
      - gax-network

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "9293:8080" # Port from your table maps to internal 8080
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    networks:
      - gax-network

  # --- Postgres Instances ---
  auth-postgres:
    image: postgres:15-alpine
    container_name: auth-PSQL
    ports:
      - "5432:5432" # External:Internal
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: auth_db
    volumes:
      - ./auth-service/migrations:/docker-entrypoint-initdb.d
    networks:
      - gax-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  user-postgres:
    image: postgres:15-alpine
    container_name: user-PSQL
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: users
    volumes:
      - ./user-service/migrations:/docker-entrypoint-initdb.d
    networks:
      - gax-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  media-postgres:
    image: postgres:15-alpine
    container_name: media-PSQL
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: media_user
      POSTGRES_PASSWORD: media_password
      POSTGRES_DB: media_db
    volumes:
      - ./media-service/migrations:/docker-entrypoint-initdb.d
    networks:
      - gax-network

  search-postgres:
    image: postgres:15-alpine
    container_name: search-PSQL
    ports:
      - "5435:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: search_db
    volumes:
      - ./search-service/migrations:/docker-entrypoint-initdb.d
    networks:
      - gax-network

  # --- Redis Instances ---
  user-redis:
    image: redis:7-alpine
    container_name: user-RDS
    ports:
      - "6379:6379"
    networks:
      - gax-network

  call-redis:
    image: redis:7-alpine
    container_name: call-RDS
    ports:
      - "6380:6379"
    networks:
      - gax-network

  room-redis:
    image: redis:7-alpine
    container_name: room-RDS
    ports:
      - "6381:6379"
    networks:
      - gax-network

  # --- Other Stores ---
  mongo:
    image: mongo:6
    container_name: chat-MDB
    ports:
      - "27017:27017"
    networks:
      - gax-network

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    networks:
      - gax-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 3

  elasticsearch:
    image: elasticsearch:7.17.15
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    networks:
      - gax-network

  kibana:
    image: kibana:7.17.15
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: '["http://elasticsearch:9200"]'
    depends_on:
      - elasticsearch
    networks:
      - gax-network

  # ==========================================
  # APPLICATION SERVICES
  # ==========================================

  auth-service:
    build: ./auth-service
    container_name: auth-service
    restart: always
    ports:
      - "8081:8081"
    environment:
      - GRPC_PORT=8081
      - POSTGRES_HOST=auth-PSQL
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=auth_db
    depends_on:
      auth-postgres:
        condition: service_healthy
    networks:
      - gax-network

  user-service:
    build: user-service
    container_name: user-service
    restart: always
    ports:
      - "8082:8082"
    environment:
      - USER_SERVICE_PORT=:8082
      - DATABASE_URL=postgres://postgres:postgres@user-PSQL:5432/users?sslmode=disable
      - REDIS_ADDR=user-RDS:6379
      - KAFKA_BROKER=kafka:9092
    depends_on:
      user-postgres:
        condition: service_healthy
      user-redis:
        condition: service_started
      kafka:
        condition: service_started
    networks:
      - gax-network

  chat-service:
    build: ./chat-service
    container_name: chat-service
    restart: always
    ports:
      - "8083:8083"
    environment:
      - CHAT_SERVICE_PORT=:8083
      - MONGO_URI=mongodb://chat-MDB:27017
      - KAFKA_BROKER=kafka:9092
      - USER_SERVICE_ADDR=user-service:8082
    depends_on:
      - mongo
      - kafka
      - user-service
    networks:
      - gax-network

  media-service:
    build: ./media-service
    container_name: media-service
    restart: always
    ports:
      - "8084:8084"
    environment:
      - PORT=8084
      - DB_URL=postgres://media_user:media_password@media-PSQL:5432/media_db?sslmode=disable
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin123
      - KAFKA_BROKER=kafka:9092
    depends_on:
      - minio
      - media-postgres
    networks:
      - gax-network

  search-service:
    build: ./search-service
    container_name: search-service
    restart: always
    ports:
      - "8085:8085"
    environment:
      - HTTP_PORT=:8085
      - POSTGRES_DSN=postgres://postgres:postgres@search-PSQL:5432/search_db?sslmode=disable
      - KAFKA_BROKER=kafka:9092
      - ELASTIC_URL=http://elasticsearch:9200
    depends_on:
      - elasticsearch
      - kafka
      - search-postgres
    networks:
      - gax-network

  call-service:
    build: ./call-service
    container_name: call-service
    restart: always
    ports:
      - "8086:8086" # WebRTC SFU needs UDP usually, but here WS TCP
      # Если используете UDP для медиа, нужно пробросить range портов
      # - "50000-50050:50000-50050/udp"
    networks:
      - gax-network

  room-service:
    build: ./room-service
    container_name: room-service
    restart: always
    ports:
      - "8087:8087"
    environment:
      - REDIS_ADDR=room-RDS:6379
    depends_on:
      - room-redis
    networks:
      - gax-network

  # ==========================================
  # GATEWAY & PROXY
  # ==========================================

  api-gateway:
    build: ./api_gateway
    container_name: api-gateway
    restart: always
    ports:
      - "8080:8080"
    environment:
      - HTTP_PORT=8080
      - AUTH_SERVICE_ADDR=auth-service:8081
      - USER_SERVICE_ADDR=user-service:8082
      - CHAT_SERVICE_ADDR=chat-service:8083
      - MEDIA_SERVICE_ADDR=http://media-service:8084
      - SEARCH_SERVICE_ADDR=http://search-service:8085
      - ROOM_SERVICE_ADDR=room-service:8087
    depends_on:
      - auth-service
      - user-service
      - chat-service
    networks:
      - gax-network

  caddy:
    image: caddy:2-alpine
    container_name: caddy-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - gax-network
    depends_on:
      - api-gateway

volumes:
  caddy_data:
  caddy_config:
