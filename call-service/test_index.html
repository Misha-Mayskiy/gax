<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Service Debugger</title>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: monospace; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header { background: #1e1e1e; padding: 15px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #333; }
        input { background: #2c2c2c; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; }
        button { background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        button.stop { background: #d32f2f; }
        
        /* –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ */
        #video-grid { flex-grow: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 10px; padding: 10px; overflow-y: auto; }
        
        /* –í–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç */
        .video-wrapper { position: relative; background: #000; border-radius: 8px; overflow: hidden; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .local-video { border: 2px solid #4CAF50; transform: scaleX(-1); } /* –ó–µ—Ä–∫–∞–ª–∏–º —Å–µ–±—è */
        .label { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        /* –õ–æ–≥–∏ */
        #logs { height: 150px; background: #000; overflow-y: scroll; padding: 10px; font-size: 12px; border-top: 1px solid #333; }
        .log-entry { margin-bottom: 2px; }
        .log-error { color: #ff5555; }
        .log-info { color: #4CAF50; }
    </style>
</head>
<body>

    <div class="header">
        <input type="text" id="roomInput" placeholder="Room ID" value="test-room">
        <input type="text" id="userInput" placeholder="User ID" value="user1">
        <button onclick="startCall()">Connect</button>
        <button class="stop" onclick="location.reload()">Disconnect</button>
        <button onclick="toggleScreen()" id="screenBtn">üñ•Ô∏è Screen</button>
    </div>

    <div id="video-grid"></div>
    <div id="logs"></div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª (wss –µ—Å–ª–∏ https, ws –µ—Å–ª–∏ http)
        const PROTOCOL = window.location.protocol === 'https:' ? 'wss' : 'ws';
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ, —Å—Ç—É—á–∏–º—Å—è –Ω–∞ 8086. –ï—Å–ª–∏ –Ω–∞ –¥–æ–º–µ–Ω–µ - –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç (Nginx –ø—Ä–æ–∫–∏–Ω–µ—Ç)
        const PORT = window.location.hostname === 'localhost' || window.location.hostname.match(/\d+\.\d+\.\d+\.\d+/) ? ':8086' : ''; 
        const BASE_URL = `${PROTOCOL}://${window.location.hostname}${PORT}/ws`;

        let ws = null;
        let pc = null;
        let localStream = null;
        let screenSender = null;
        
        // –û—á–µ—Ä–µ–¥–∏ –¥–ª—è Race Conditions
        let isRemoteDescriptionSet = false;
        let candidateQueue = [];

        function log(msg, type = '') {
            const div = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.appendChild(entry);
            div.scrollTop = div.scrollHeight;
            console.log(msg);
        }

        async function startCall() {
            const roomID = document.getElementById('roomInput').value;
            const userID = document.getElementById('userInput').value;
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ (–°–ù–ê–ß–ê–õ–ê!)
                log("Requesting camera/mic...");
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–µ–±—è
                addVideo(localStream, "Me (Local)", true);

                // 2. –°–æ–∑–¥–∞–µ–º PC
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                });

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–µ–∫–æ–≤
                pc.ontrack = (event) => {
                    log(`Track received: ${event.track.kind} (${event.streams[0].id})`, 'info');
                    const stream = event.streams[0];
                    
                    // –ï—Å–ª–∏ –≤–∏–¥–µ–æ —É–∂–µ –µ—Å—Ç—å, –Ω–µ —Å–æ–∑–¥–∞–µ–º –¥—É–±–ª—å (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ addVideo)
                    addVideo(stream, `Remote (${event.track.kind})`, false);
                    
                    event.track.onmute = () => log(`Track muted: ${event.track.kind}`);
                    event.track.onunmute = () => log(`Track unmuted: ${event.track.kind}`);
                };

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                pc.onicecandidate = (event) => {
                    if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: "candidate", payload: event.candidate }));
                    }
                };

                pc.onconnectionstatechange = () => log(`PC State: ${pc.connectionState}`, 'info');

                // 3. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WS
                log(`Connecting to ${BASE_URL}...`);
                ws = new WebSocket(BASE_URL);

                ws.onopen = () => {
                    log("WebSocket Connected!", 'info');
                    // –≠–º—É–ª–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-User-ID —á–µ—Ä–µ–∑ payload (—Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Ç–µ—Å—Ç –±–µ–∑ Gateway)
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ Gateway –≤—ã—Ä–µ–∑–∞–µ—Ç —ç—Ç–æ –∏ —Å—Ç–∞–≤–∏—Ç Header
                    ws.send(JSON.stringify({
                        type: "join",
                        payload: { room_id: roomID, user_id: userID } // user_id —Ç—É—Ç –∫–∞–∫ fallback –¥–ª—è —Ç–µ—Å—Ç–∞
                    }));
                };

                ws.onclose = () => log("WebSocket Disconnected", 'error');
                ws.onerror = (e) => log("WebSocket Error", 'error');

                ws.onmessage = async (event) => {
                    const msg = JSON.parse(event.data);
                    
                    if (msg.type === "offer") {
                        log("Received Offer from Server");
                        try {
                            await pc.setRemoteDescription(msg.payload);
                            isRemoteDescriptionSet = true;
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—á–µ—Ä–µ–¥—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                            while(candidateQueue.length) {
                                await pc.addIceCandidate(candidateQueue.shift());
                            }

                            const answer = await pc.createAnswer();
                            await pc.setLocalDescription(answer);
                            ws.send(JSON.stringify({ type: "answer", payload: answer }));
                            log("Sent Answer");
                        } catch(e) { log("Offer Error: " + e, 'error'); }
                    }
                    else if (msg.type === "answer") {
                        log("Received Answer from Server"); // –†–µ–¥–∫–æ, —Ç–∞–∫ –∫–∞–∫ —Å–µ—Ä–≤–µ—Ä –æ–±—ã—á–Ω–æ —à–ª–µ—Ç Offer
                        await pc.setRemoteDescription(msg.payload);
                    }
                    else if (msg.type === "candidate") {
                        if (isRemoteDescriptionSet) {
                            pc.addIceCandidate(msg.payload).catch(e => log("ICE Error: " + e, 'error'));
                        } else {
                            candidateQueue.push(msg.payload);
                        }
                    }
                    else if (msg.type === "user_left") {
                        log(`User left. Cleaning streams: ${msg.payload.stream_ids}`);
                        msg.payload.stream_ids.forEach(id => removeVideo(id));
                    }
                };

            } catch (e) {
                log("Error: " + e, 'error');
                alert("Error: " + e.message);
            }
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ UI ---

        function addVideo(stream, labelText, isLocal) {
            const grid = document.getElementById('video-grid');
            const id = stream.id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID —Å—Ç—Ä–∏–º–∞ –∫–∞–∫ –∫–ª—é—á

            if (document.getElementById(`wrap-${id}`)) return; // –£–∂–µ –µ—Å—Ç—å

            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            wrapper.id = `wrap-${id}`;

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            if (isLocal) video.classList.add('local-video');
            video.muted = isLocal; // –°–µ–±—è –Ω–µ —Å–ª—ã—à–∏–º, –¥—Ä—É–≥–∏—Ö —Å–ª—ã—à–∏–º

            const label = document.createElement('div');
            label.className = 'label';
            label.innerText = labelText;

            wrapper.appendChild(video);
            wrapper.appendChild(label);
            grid.appendChild(wrapper);
        }

        function removeVideo(streamId) {
            const el = document.getElementById(`wrap-${streamId}`);
            if (el) el.remove();
        }

        async function toggleScreen() {
            const btn = document.getElementById('screenBtn');
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: —Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫. 
            // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è —Ç–µ—Å—Ç–∞)
            if (btn.style.background === 'orange') {
                alert("Reload page to stop sharing (Test mode)");
                return;
            }

            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const track = screenStream.getVideoTracks()[0];
                
                screenSender = pc.addTrack(track, screenStream);
                addVideo(screenStream, "My Screen", true);
                
                // Renegotiation (–≥–æ–≤–æ—Ä–∏–º —Å–µ—Ä–≤–µ—Ä—É –ø—Ä–æ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫)
                // –¢–∞–∫ –∫–∞–∫ –º—ã –∫–ª–∏–µ–Ω—Ç, –∞ —Å–µ—Ä–≤–µ—Ä –∂–¥–µ—Ç, —á—Ç–æ –æ–Ω –≥–ª–∞–≤–Ω—ã–π,
                // –º—ã –º–æ–∂–µ–º –ø–æ—Å–ª–∞—Ç—å Offer, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç.
                // –í –Ω–∞—à–µ–º –∫–æ–¥–µ (handler.go) –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Ö–æ–¥—è—â–µ–≥–æ Offer!
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: "offer", payload: offer }));
                
                btn.style.background = 'orange';
            } catch(e) { log("Screen Share Error: " + e, 'error'); }
        }
    </script>
</body>
</html>