<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Music Room - –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ</title>
    <style>
        /* ... CSS —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        header {
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        .status {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            margin: 10px;
        }
        
        .status.connected {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        
        .status.disconnected {
            background: linear-gradient(45deg, #ff4444, #cc0000);
        }
        
        .room-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h2 {
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        h3 {
            margin: 15px 0;
            color: #ff6b6b;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        input, button {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
        }
        
        input {
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }
        
        .player-container {
            margin: 30px 0;
        }
        
        #youtube-player {
            width: 100%;
            max-width: 800px;
            height: 450px;
            margin: 0 auto;
            border-radius: 10px;
        }
        
        audio {
            width: 100%;
            max-width: 800px;
            margin: 20px 0;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 15px 30px;
            font-size: 18px;
            min-width: 200px;
        }
        
        .users-list {
            list-style: none;
            margin: 20px 0;
        }
        
        .user-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            margin: 10px 0;
            border-radius: 10px;
            text-align: left;
            border-left: 4px solid #4ecdc4;
        }
        
        .user-item.host {
            border-left-color: #ff6b6b;
        }
        
        #messageLog {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            input {
                min-width: 100%;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Music Room</h1>
            <p class="subtitle">–°–ª—É—à–∞–π—Ç–µ –º—É–∑—ã–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å –¥—Ä—É–∑—å—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
            <div id="connectionStatus" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
        </header>

        <section class="room-section">
            <h2>üéØ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ</h2>
            <div class="input-group">
                <input type="text" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="demo-room">
                <input type="text" id="userId" placeholder="–í–∞—à–µ –∏–º—è" value="–ì–æ—Å—Ç—å">
                <button onclick="connectToRoom()" id="connectBtn">üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
        </section>

        <section id="musicSection" class="room-section hidden">
            <h2>üéµ –í—ã–±–æ—Ä –º—É–∑—ã–∫–∏</h2>
            
            <div class="input-group">
                <input type="text" id="youtubeUrl" 
                       placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É YouTube (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://youtube.com/watch?v=...)"
                       value="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                <button onclick="loadYouTubeVideo()">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
            </div>
            
            <div class="player-container">
                <div id="youtube-player"></div>
            </div>
            
            <div class="input-group">
                <h3>–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ MP3 —Ñ–∞–π–ª:</h3>
                <input type="text" id="mp3Url" 
                       placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ MP3 —Ñ–∞–π–ª"
                       value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">
                <button onclick="loadMP3()">üéµ –ó–∞–≥—Ä—É–∑–∏—Ç—å MP3</button>
            </div>
            
            <div class="player-container">
                <audio id="audioPlayer" controls crossorigin="anonymous">
                    <source id="mp3SourceElement" src="" type="audio/mpeg">
                </audio>
            </div>
        </section>

        <section id="controlSection" class="room-section hidden">
            <h2>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            
            <div class="controls">
                <button class="control-btn" onclick="sendControl('play')">‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</button>
                <button class="control-btn" onclick="sendControl('pause')">‚è∏ –ü–∞—É–∑–∞</button>
                <button class="control-btn" onclick="sendControl('seek')">‚Üª –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="control-btn danger" onclick="disconnectFromRoom()">‚ùå –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            </div>
            
            <div class="controls">
                <button onclick="skipBackward()">‚è™ –ù–∞–∑–∞–¥ 10—Å</button>
                <button onclick="skipForward()">‚è© –í–ø–µ—Ä–µ–¥ 10—Å</button>
                <button onclick="toggleMute()" id="muteBtn">üîá –í—ã–∫–ª –∑–≤—É–∫</button>
            </div>
        </section>

        <section id="usersSection" class="room-section hidden">
            <h2>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
            <div class="users-list" id="usersList">
                <div class="user-item">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </section>

        <section class="room-section">
            <h2>üìä –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h2>
            <div id="messageLog">
                <div class="log-entry">[–°–∏—Å—Ç–µ–º–∞] –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Music Room!</div>
                <div class="log-entry">[–°–∏—Å—Ç–µ–º–∞] –î–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ</div>
            </div>
            <button onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </section>
    </div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let ws = null;
        let currentRoom = null;
        let currentUser = null;
        let youtubePlayer = null;
        let audioPlayer = document.getElementById('audioPlayer');
        let isSyncing = false;
        let users = {};

        // ==================== –£–¢–ò–õ–ò–¢–´ ====================
        function log(message, type = 'system') {
            const logElement = document.getElementById('messageLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            if (connected) {
                statusElement.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                connectBtn.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('musicSection').classList.remove('hidden');
                document.getElementById('controlSection').classList.remove('hidden');
                document.getElementById('usersSection').classList.remove('hidden');
            } else {
                statusElement.textContent = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                connectBtn.textContent = 'üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
                document.getElementById('musicSection').classList.add('hidden');
                document.getElementById('controlSection').classList.add('hidden');
                document.getElementById('usersSection').classList.add('hidden');
            }
        }

        function extractYouTubeId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length == 11) ? match[7] : false;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ==================== –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï ====================
        function onYouTubeIframeAPIReady() {
            log('YouTube API –≥–æ—Ç–æ–≤', 'system');
        }

        function loadYouTubeVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const videoId = extractYouTubeId(url);
            
            if (!videoId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ YouTube');
                return;
            }
            
            if (!youtubePlayer) {
                youtubePlayer = new YT.Player('youtube-player', {
                    height: '450',
                    width: '800',
                    videoId: videoId,
                    playerVars: {
                        'playsinline': 1,
                        'controls': 1,
                        'rel': 0
                    },
                    events: {
                        'onReady': onYouTubePlayerReady,
                        'onStateChange': onYouTubePlayerStateChange
                    }
                });
            } else {
                youtubePlayer.loadVideoById(videoId);
            }
            
            log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ YouTube –≤–∏–¥–µ–æ: ${videoId}`, 'system');
        }

        function onYouTubePlayerReady(event) {
            log('YouTube –ø–ª–µ–µ—Ä –≥–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é', 'system');
        }

        function onYouTubePlayerStateChange(event) {
            if (isSyncing) return;
            
            if (event.data === YT.PlayerState.PLAYING) {
                sendControl('play', event.target.getCurrentTime());
            } else if (event.data === YT.PlayerState.PAUSED) {
                sendControl('pause', event.target.getCurrentTime());
            }
        }

        function loadMP3() {
            const url = document.getElementById('mp3Url').value;
            if (!url) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL MP3 —Ñ–∞–π–ª–∞');
                return;
            }
            
            const sourceElement = document.getElementById('mp3SourceElement');
            sourceElement.src = url;
            audioPlayer.load();
            
            audioPlayer.onloadedmetadata = function() {
                log(`MP3 –∑–∞–≥—Ä—É–∂–µ–Ω: ${url}`, 'system');
            };
            
            audioPlayer.onerror = function() {
                log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ MP3 —Ñ–∞–π–ª–∞', 'error');
            };
        }

        audioPlayer.addEventListener('play', function() {
            if (isSyncing) return;
            sendControl('play', audioPlayer.currentTime);
        });

        audioPlayer.addEventListener('pause', function() {
            if (isSyncing) return;
            sendControl('pause', audioPlayer.currentTime);
        });

        audioPlayer.addEventListener('seeked', function() {
            if (isSyncing) return;
            sendControl('seek', audioPlayer.currentTime);
        });

        // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
        function sendControl(action, position = null) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ', 'error');
                return;
            }
            
            const message = {
                type: 'control',
                action: action,
                roomId: currentRoom,
                userId: currentUser.id,
                userName: currentUser.name,
                timestamp: Date.now()
            };
            
            if (position !== null) {
                message.position = position;
            }
            
            ws.send(JSON.stringify(message));
            log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${action} ${position ? `(–ø–æ–∑–∏—Ü–∏—è: ${formatTime(position)})` : ''}`, 'outgoing');
        }

        function skipBackward() {
            if (youtubePlayer) {
                const newTime = Math.max(0, youtubePlayer.getCurrentTime() - 10);
                youtubePlayer.seekTo(newTime, true);
            }
            if (audioPlayer.src) {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
            }
        }

        function skipForward() {
            if (youtubePlayer) {
                const newTime = youtubePlayer.getCurrentTime() + 10;
                youtubePlayer.seekTo(newTime, true);
            }
            if (audioPlayer.src) {
                audioPlayer.currentTime += 10;
            }
        }

        function toggleMute() {
            const btn = document.getElementById('muteBtn');
            if (youtubePlayer) {
                const isMuted = youtubePlayer.isMuted();
                if (isMuted) {
                    youtubePlayer.unMute();
                    btn.textContent = 'üîá –í—ã–∫–ª –∑–≤—É–∫';
                } else {
                    youtubePlayer.mute();
                    btn.textContent = 'üîà –í–∫–ª –∑–≤—É–∫';
                }
            }
            if (audioPlayer.src) {
                audioPlayer.muted = !audioPlayer.muted;
                btn.textContent = audioPlayer.muted ? 'üîà –í–∫–ª –∑–≤—É–∫' : 'üîá –í—ã–∫–ª –∑–≤—É–∫';
            }
        }

        // ==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ====================
        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            const userArray = Object.values(users);
            
            if (userArray.length === 0) {
                usersList.innerHTML = '<div class="user-item">–í –∫–æ–º–Ω–∞—Ç–µ –ø–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</div>';
                return;
            }
            
            userArray.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `user-item ${user.isHost ? 'host' : ''}`;
                userElement.innerHTML = `
                    <strong>${user.name}</strong> ${user.isHost ? 'üëë' : ''}
                `;
                usersList.appendChild(userElement);
            });
        }

        // ==================== WEB SOCKET ====================
        function connectToRoom() {
            const roomId = document.getElementById('roomId').value;
            const userName = document.getElementById('userId').value;
            
            if (!roomId || !userName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ –≤–∞—à–µ –∏–º—è');
                return;
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.disabled = true;
            connectBtn.textContent = '–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...';
            
            currentRoom = roomId;
            currentUser = {
                id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: userName,
                isHost: false,
                joinedAt: Date.now()
            };
            
            const wsUrl = `ws://${window.location.host}/ws?room_id=${encodeURIComponent(roomId)}&user_id=${encodeURIComponent(currentUser.id)}&user_name=${encodeURIComponent(userName)}`;
            
            log(`–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket: ${wsUrl}`, 'system');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomId}" –∫–∞–∫ "${userName}"`, 'system');
                updateStatus(true);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const message = {
                    type: 'user_join',
                    roomId: roomId,
                    user: currentUser,
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(message));
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error.message}`, 'error');
                    console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ JSON:', event.data);
                }
            };
            
            ws.onclose = function(event) {
                log(`üì¥ –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç –∫–æ–º–Ω–∞—Ç—ã. –ö–æ–¥: ${event.code}, –ü—Ä–∏—á–∏–Ω–∞: ${event.reason || '–Ω–µ—Ç'}`, 'system');
                updateStatus(false);
                currentRoom = null;
                currentUser = null;
                users = {};
                updateUsersList();
            };
            
            ws.onerror = function(error) {
                log(`‚ùå –û—à–∏–±–∫–∞ WebSocket: ${error.type}`, 'error');
                connectBtn.disabled = false;
                connectBtn.textContent = 'üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
            };
        }

        function handleWebSocketMessage(data) {
            console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            if (data.type === 'room_info' && Array.isArray(data.users)) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                users = {};
                data.users.forEach(user => {
                    if (user && user.id) {
                        users[user.id] = user;
                    }
                });
                updateUsersList();
                log(`üë• –í –∫–æ–º–Ω–∞—Ç–µ ${data.users.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`, 'system');
                return;
            }
            
            if (data.type === 'user_joined' && data.user) {
                // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
                users[data.user.id] = data.user;
                updateUsersList();
                log(`üë§ ${data.user.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`, 'system');
                return;
            }
            
            if (data.type === 'user_left' && data.user) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É
                delete users[data.user.id];
                updateUsersList();
                log(`üë§ ${data.user.name} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`, 'system');
                return;
            }
            
            if (data.type === 'play' || data.type === 'pause' || data.type === 'seek') {
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
                handlePlaybackControl(data.type, data.position, data.userName, data.userId);
                return;
            }
            
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
            log(`üì® ${JSON.stringify(data)}`, 'incoming');
        }

        function handlePlaybackControl(action, position, userName, userId) {
            if (userId === currentUser.id) {
                return; // –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            }
            
            log(`üéÆ ${userName || '–ö—Ç–æ-—Ç–æ'}: ${action} ${position ? `–Ω–∞ ${formatTime(position)}` : ''}`, 'system');
            
            isSyncing = true;
            
            try {
                switch(action) {
                    case 'play':
                        if (youtubePlayer && youtubePlayer.playVideo) {
                            if (position !== undefined && position !== null) {
                                youtubePlayer.seekTo(position, true);
                            }
                            youtubePlayer.playVideo();
                        }
                        if (audioPlayer.src) {
                            if (position !== undefined && position !== null) {
                                audioPlayer.currentTime = position;
                            }
                            audioPlayer.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
                        }
                        break;
                        
                    case 'pause':
                        if (youtubePlayer && youtubePlayer.pauseVideo) {
                            youtubePlayer.pauseVideo();
                        }
                        if (audioPlayer.src) {
                            audioPlayer.pause();
                        }
                        break;
                        
                    case 'seek':
                        if (position !== undefined && position !== null) {
                            if (youtubePlayer && youtubePlayer.seekTo) {
                                youtubePlayer.seekTo(position, true);
                            }
                            if (audioPlayer.src) {
                                audioPlayer.currentTime = position;
                            }
                        }
                        break;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã:', error);
            }
            
            setTimeout(() => { isSyncing = false; }, 100);
        }

        function disconnectFromRoom() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'user_leave',
                    roomId: currentRoom,
                    user: currentUser,
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(message));
                ws.close();
            } else {
                updateStatus(false);
                currentRoom = null;
                currentUser = null;
                users = {};
                updateUsersList();
            }
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        window.addEventListener('load', function() {
            log('üéµ Music Room –∑–∞–≥—Ä—É–∂–µ–Ω', 'system');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
            setTimeout(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const autoRoom = urlParams.get('room');
                const autoUser = urlParams.get('user');
                
                if (autoRoom) {
                    document.getElementById('roomId').value = autoRoom;
                }
                if (autoUser) {
                    document.getElementById('userId').value = autoUser;
                }
                
                if (autoRoom && autoUser) {
                    log('üîó –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'system');
                    setTimeout(() => connectToRoom(), 500);
                } else {
                    log('üëÜ –î–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ', 'system');
                }
            }, 1000);
        });

        function clearLogs() {
            document.getElementById('messageLog').innerHTML = `
                <div class="log-entry">[–°–∏—Å—Ç–µ–º–∞] –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</div>
            `;
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.MusicRoom = {
            connectToRoom,
            disconnectFromRoom,
            sendControl,
            loadYouTubeVideo,
            loadMP3,
            clearLogs,
            getState: () => ({
                ws: ws ? {
                    readyState: ws.readyState,
                    url: ws.url
                } : null,
                currentRoom,
                currentUser,
                users,
                youtubePlayer: !!youtubePlayer,
                isSyncing
            })
        };
    </script>
</body>
</html>