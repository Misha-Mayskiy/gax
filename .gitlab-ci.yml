image: golang:1.25-alpine

variables:
  GOPATH: $CI_PROJECT_DIR/.go
  CGO_ENABLED: 0

cache:
  paths:
    - .go/pkg/mod/

stages:
  - test
  - build
  - deploy

before_script:
  - apk add --no-cache make git bc grep openssh-client

# –®–ê–ë–õ–û–ù –î–õ–Ø –¢–ï–°–¢–û–í
.test_template: &test_definition
  stage: test
  script:
    - cd $SERVICE_DIR
    - echo "üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ $SERVICE_DIR —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–∫—Ä—ã—Ç–∏—è..."
    - go mod download

    # 1. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤. –ï—Å–ª–∏ —É–ø–∞–¥—É—Ç, –ø–∞–π–ø–ª–∞–π–Ω –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è.
    - go test -v -coverprofile=coverage.raw ./...

    # 2. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    - grep -vE "cmd/|client/|pkg/db|pkg/api|mock|test" coverage.raw > coverage.out

    # 3. –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞
    - COVERAGE=$(go tool cover -func=coverage.out 2>/dev/null | grep total | awk '{print $3}' | tr -d '%' || echo "0.0")
    - echo "üìä –ü–æ–∫—Ä—ã—Ç–∏–µ –¥–ª—è $SERVICE_DIR - $COVERAGE%"

    # 4. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞, –µ—Å–ª–∏ –ø–æ–∫—Ä—ã—Ç–∏–µ –Ω–∏–∂–µ 30%
    - |
      if [ $(echo "$COVERAGE < 30.0" | bc) -eq 1 ]; then
        echo "‚ùå FAILURE: –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ —Ç–µ—Å—Ç–∞–º–∏ ($COVERAGE%) –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ 30%."
        exit 1
      else
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞."
      fi

# –®–ê–ë–õ–û–ù –î–õ–Ø –°–ë–û–†–ö–ò
.build_template: &build_definition
  stage: build
  script:
    - cd $SERVICE_DIR
    - echo "üî® –°–±–æ—Ä–∫–∞ $SERVICE_DIR..."
    - go mod download
    - |
      if [ -f "$MAIN_PATH" ]; then
        echo "‚úÖ Found main file at $MAIN_PATH"
        go build -p 1 -o ../bin/$SERVICE_NAME $MAIN_PATH
      else
        echo "‚ùå Error: main.go NOT found at $MAIN_PATH"
        ls -R
        exit 1
      fi
    - ls -lh ../bin/$SERVICE_NAME
  artifacts:
    paths:
      - bin/
    expire_in: 1 week

# JOBS (–°–ï–†–í–ò–°–´)

# --- User Service ---
test:user-service:
  variables: { SERVICE_DIR: "user-service" }
  <<: *test_definition

build:user-service:
  variables:
    SERVICE_DIR: "user-service"
    SERVICE_NAME: "user-service"
    MAIN_PATH: "./cmd/app/main.go"
  <<: *build_definition

# --- Auth Service ---
test:auth-service:
  variables: { SERVICE_DIR: "auth-service" }
  <<: *test_definition

build:auth-service:
  variables:
    SERVICE_DIR: "auth-service"
    SERVICE_NAME: "auth-service"
    MAIN_PATH: "./cmd/server/main.go"
  <<: *build_definition

# --- Chat Service ---
test:chat-service:
  variables: { SERVICE_DIR: "chat-service" }
  <<: *test_definition

build:chat-service:
  variables:
    SERVICE_DIR: "chat-service"
    SERVICE_NAME: "chat-service"
    MAIN_PATH: "./cmd/app/main.go"
  <<: *build_definition

# --- Media Service ---
test:media-service:
  variables: { SERVICE_DIR: "media-service" }
  <<: *test_definition

build:media-service:
  variables:
    SERVICE_DIR: "media-service"
    SERVICE_NAME: "media-service"
    MAIN_PATH: "./cmd/main.go"
  <<: *build_definition

# --- Search Service ---
test:search-service:
  variables: { SERVICE_DIR: "search-service" }
  <<: *test_definition

build:search-service:
  variables:
    SERVICE_DIR: "search-service"
    SERVICE_NAME: "search-service"
    MAIN_PATH: "./cmd/search-service/main.go"
  <<: *build_definition

# --- Room Service ---
test:room-service:
  variables: { SERVICE_DIR: "room-service" }
  <<: *test_definition

build:room-service:
  variables:
    SERVICE_DIR: "room-service"
    SERVICE_NAME: "room-service"
    MAIN_PATH: "./cmd/room-service/main.go"
  <<: *build_definition

# --- Call Service ---
test:call-service:
  variables: { SERVICE_DIR: "call-service" }
  <<: *test_definition

build:call-service:
  variables:
    SERVICE_DIR: "call-service"
    SERVICE_NAME: "call-service"
    MAIN_PATH: "./cmd/main.go"
  <<: *build_definition

# --- API Gateway (–¢–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤) ---
test:api-gateway:
  stage: test
  variables:
    SERVICE_DIR: "api_gateway"
  script:
    - cd $SERVICE_DIR
    - echo "üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ $SERVICE_DIR (–±–µ–∑ Quality Gate –ø–æ –ø–æ–∫—Ä—ã—Ç–∏—é)..."
    - go mod download
    # –§–ª–∞–≥ –ø–æ–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –ª–æ–≥–æ–≤ (-cover)
    - go test -v -cover ./...

build:api-gateway:
  stage: build
  variables:
    SERVICE_DIR: "api_gateway"
    SERVICE_NAME: "api-gateway"
    MAIN_PATH: "./cmd/app/main.go"
  script:
    - cd $SERVICE_DIR
    - echo "üî® –°–±–æ—Ä–∫–∞ $SERVICE_DIR..."
    - go mod download
    - go build -p 1 -o ../bin/$SERVICE_NAME $MAIN_PATH
  artifacts:
    paths:
      - bin/

# DEPLOY STAGE
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "üöÄ Deploying to production server..."
    - ssh root@$SERVER_IP "set -e && cd /root/gax && git pull origin main && chmod +x deploy.sh && ./deploy.sh"
  only:
    - main
